- name: install docker deps
  apt:
    pkg: "{{ pkg_item }}"
    state: present
    update_cache: no
    install_recommends: no
  with_items: '{{ docker_deps }}'
  loop_control:
    loop_var: pkg_item

- name: add repository key
  apt_key:
    url: https://download.docker.com/linux/{{ ansible_distribution.lower() }}/gpg
    id: 0EBFCD88

- name: add repository
  apt_repository:
    repo: >
      deb [arch=amd64]
      https://download.docker.com/linux/{{ ansible_distribution.lower() }}
      {{ ansible_lsb.codename }}
      stable
  notify: update apt caches

- meta: flush_handlers

- name: install docker
  apt:
    pkg: docker-ce
    state: present
    update_cache: no
    install_recommends: yes
  notify: restart docker

# Please note that you need to mount /tmp with exec permissions!
# -> http://zindo.info/docker-compose-error-while-loading-libz-so-1.html
- name: install docker-compose
  get_url:
    url: https://github.com/docker/compose/releases/download/{{ docker_compose_version }}/docker-compose-{{ ansible_system }}-{{ ansible_architecture }}
    dest: /usr/local/bin/docker-compose
    owner: root
    group: root
    mode: 0755
